# 第6章 代码分片

[[toc]]

## 环境配置的封装
```json
// package.json
"scripts": {
    "dev": "ENV=development webpack-dev-server",
    "build": "ENV=production webpack"
}

// webpack.config.js
const ENV = process.env.ENV;
```
```json
// package.json
"scripts": {
    "dev": "webpack-dev-server --config=webpack.development.config.js",
    "build": "webpack --config=webpack.production.config.js"
}
```

## 开启production模式

### 环境变量
```js
// webpack.config.js
const webpack = require('webpack');
module.exports = {
    entry: './app.js',
    +  mode: 'production',
    -  plugins: [
    -    new UglifyJsPlugin(/* ... */),
    -    new webpack.DefinePlugin({ "process.env.NODE_ENV": JSON.stringify("production") }),
    -    new webpack.optimize.ModuleConcatenationPlugin(),
    -    new webpack.NoEmitOnErrorsPlugin()
    -  ]
}

// app.js
console.log(ENV)// production
```
DefinePlugin在替换环境变量时对于字符串类型的值进行的是完全替换。不添加JSON.stringify，在替换后就会成为变量名，而非字符串值。所以字符串或者包含字符串的对象都要加上JSON.stringify。
```js
new webpack.DefinePlugin({
    ccc: JSON.stringify({
        a: 'abc'
    })
})
```

webpack4中如果启用了mode: production，则已经设置好process.env.NODE_ENV=production。

### source map
source map指的是将编译、打包、压缩后的代码映射回源代码的过程。      
**我们启动了devtool配置项，source map就会跟随源代码一步步被传递，直到生成最后的map文件。bundle.js.map。**   
**map文件只会在浏览器打开开发者工具时被加载。所以对用户使用是没有任何影响的，但是任何人都可以看到源码。**

#### 配置
对于js
```js
module.exports = {
    devtool: 'source-map'
}
```
对于CSS、SCSS、LESS来说，还需要：
```js
devtool: 'source-map',
module: {
    rules: [
        {
            test: /\.scss$/,
            use: [
                'style-loader',
                {
                    loader: 'css-loader',
                    options: {
                        sourceMap: true
                    }
                },
                {
                    loader: 'sass-loader',
                    options: {
                        sourceMap: true
                    }
                },
            ]
        }
    ]
}
```
之后就可以在开发者工具“Sources”下的“webpack://”目录中找到工程源码。

生成完整source map会延长整体构建时间，如果对打包速度需求比较高的话，可以选择一个简化版的source map。cheap-module-eval-source-map属于打包速度和源码信息还原程度的一个良好的折中。

`hidden-source-map`webpack仍然会产出完整的map文件，只不过不会在bundle文件中添加对于map文件的引用。  
`nosources-source-map`打包部署后可以在Sources选项卡中看到源码的目录结构，但是文件的具体内容会被隐藏起来。

**生成环境中还可以使用source map，然后通过设置nginx将.map文件只对固定的白名单（公司内网开发），这样用户看不到源码，我们能看到源码。**

## 资源压缩
